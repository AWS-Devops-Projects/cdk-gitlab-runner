{
  "version": "tree-0.1",
  "tree": {
    "id": "App",
    "path": "",
    "children": {
      "Tree": {
        "id": "Tree",
        "path": "Tree"
      },
      "testing-stack": {
        "id": "testing-stack",
        "path": "testing-stack",
        "children": {
          "testing": {
            "id": "testing",
            "path": "testing-stack/testing",
            "children": {
              "VPC": {
                "id": "VPC",
                "path": "testing-stack/testing/VPC",
                "children": {
                  "PublicSubnet1": {
                    "id": "PublicSubnet1",
                    "path": "testing-stack/testing/VPC/PublicSubnet1"
                  },
                  "PublicSubnet2": {
                    "id": "PublicSubnet2",
                    "path": "testing-stack/testing/VPC/PublicSubnet2"
                  },
                  "PublicSubnet3": {
                    "id": "PublicSubnet3",
                    "path": "testing-stack/testing/VPC/PublicSubnet3"
                  }
                }
              },
              "GitlabRunner": {
                "id": "GitlabRunner",
                "path": "testing-stack/testing/GitlabRunner",
                "children": {
                  "InstanceSecurityGroup": {
                    "id": "InstanceSecurityGroup",
                    "path": "testing-stack/testing/GitlabRunner/InstanceSecurityGroup",
                    "children": {
                      "Resource": {
                        "id": "Resource",
                        "path": "testing-stack/testing/GitlabRunner/InstanceSecurityGroup/Resource",
                        "attributes": {
                          "aws:cdk:cloudformation:type": "AWS::EC2::SecurityGroup",
                          "aws:cdk:cloudformation:props": {
                            "groupDescription": "testing-stack/testing/GitlabRunner/InstanceSecurityGroup",
                            "securityGroupEgress": [
                              {
                                "cidrIp": "0.0.0.0/0",
                                "description": "Allow all outbound traffic by default",
                                "ipProtocol": "-1"
                              }
                            ],
                            "tags": [
                              {
                                "key": "Name",
                                "value": "Gitlab-Runner"
                              }
                            ],
                            "vpcId": "vpc-c1a997a6"
                          }
                        }
                      }
                    }
                  },
                  "InstanceRole": {
                    "id": "InstanceRole",
                    "path": "testing-stack/testing/GitlabRunner/InstanceRole",
                    "children": {
                      "Resource": {
                        "id": "Resource",
                        "path": "testing-stack/testing/GitlabRunner/InstanceRole/Resource",
                        "attributes": {
                          "aws:cdk:cloudformation:type": "AWS::IAM::Role",
                          "aws:cdk:cloudformation:props": {
                            "assumeRolePolicyDocument": {
                              "Statement": [
                                {
                                  "Action": "sts:AssumeRole",
                                  "Effect": "Allow",
                                  "Principal": {
                                    "Service": "ec2.amazonaws.com"
                                  }
                                }
                              ],
                              "Version": "2012-10-17"
                            },
                            "managedPolicyArns": [
                              {
                                "Fn::Join": [
                                  "",
                                  [
                                    "arn:",
                                    {
                                      "Ref": "AWS::Partition"
                                    },
                                    ":iam::aws:policy/AmazonSSMManagedInstanceCore"
                                  ]
                                ]
                              }
                            ],
                            "tags": [
                              {
                                "key": "Name",
                                "value": "Gitlab-Runner"
                              }
                            ]
                          }
                        }
                      }
                    }
                  },
                  "InstanceProfile": {
                    "id": "InstanceProfile",
                    "path": "testing-stack/testing/GitlabRunner/InstanceProfile",
                    "attributes": {
                      "aws:cdk:cloudformation:type": "AWS::IAM::InstanceProfile",
                      "aws:cdk:cloudformation:props": {
                        "roles": [
                          {
                            "Ref": "testingGitlabRunnerInstanceRoleDFCF3F3C"
                          }
                        ]
                      }
                    }
                  },
                  "Resource": {
                    "id": "Resource",
                    "path": "testing-stack/testing/GitlabRunner/Resource",
                    "attributes": {
                      "aws:cdk:cloudformation:type": "AWS::EC2::Instance",
                      "aws:cdk:cloudformation:props": {
                        "availabilityZone": "ap-northeast-1a",
                        "blockDeviceMappings": [
                          {
                            "deviceName": "/dev/xvda",
                            "ebs": {
                              "volumeSize": 60
                            }
                          }
                        ],
                        "iamInstanceProfile": {
                          "Ref": "testingGitlabRunnerInstanceProfile26901481"
                        },
                        "imageId": {
                          "Ref": "SsmParameterValueawsserviceamiamazonlinuxlatestamznamihvmx8664gp2C96584B6F00A464EAD1953AFF4B05118Parameter"
                        },
                        "instanceType": "t3.large",
                        "securityGroupIds": [
                          {
                            "Fn::GetAtt": [
                              "testingGitlabRunnerInstanceSecurityGroup411A80B0",
                              "GroupId"
                            ]
                          }
                        ],
                        "subnetId": "subnet-cbdc2783",
                        "tags": [
                          {
                            "key": "Name",
                            "value": "Gitlab-Runner"
                          }
                        ],
                        "userData": {
                          "Fn::Base64": "#!/bin/bash\nyum update -y\nyum install docker -y\nservice docker start\nusermod -aG docker ec2-user\nchmod +x /var/run/docker.sock\nservice docker restart &&  chkconfig docker on\ndocker run -d -v /home/ec2-user/.gitlab-runner:/etc/gitlab-runner -v /var/run/docker.sock:/var/run/docker.sock --name gitlab-runner-register gitlab/gitlab-runner:alpine register --non-interactive --url https://gitlab.com./ --registration-token GITLABTOKEN  --docker-volumes \"/var/run/docker.sock:/var/run/docker.sock\" --executor docker --docker-image \"alpine:latest\" --description \"Docker Runner\" --tag-list \"gitlab,runner,awscdk\" --docker-privileged\nsleep 2 && docker run --restart always -d -v /home/ec2-user/.gitlab-runner:/etc/gitlab-runner -v /var/run/docker.sock:/var/run/docker.sock --name gitlab-runner gitlab/gitlab-runner:alpine\nusermod -aG docker ssm-user"
                        }
                      }
                    }
                  }
                }
              },
              "Runner-ID": {
                "id": "Runner-ID",
                "path": "testing-stack/testing/Runner-ID"
              }
            }
          },
          "SsmParameterValue:--aws--service--ami-amazon-linux-latest--amzn-ami-hvm-x86_64-gp2:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter": {
            "id": "SsmParameterValue:--aws--service--ami-amazon-linux-latest--amzn-ami-hvm-x86_64-gp2:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter",
            "path": "testing-stack/SsmParameterValue:--aws--service--ami-amazon-linux-latest--amzn-ami-hvm-x86_64-gp2:C96584B6-F00A-464E-AD19-53AFF4B05118.Parameter"
          },
          "SsmParameterValue:--aws--service--ami-amazon-linux-latest--amzn-ami-hvm-x86_64-gp2:C96584B6-F00A-464E-AD19-53AFF4B05118": {
            "id": "SsmParameterValue:--aws--service--ami-amazon-linux-latest--amzn-ami-hvm-x86_64-gp2:C96584B6-F00A-464E-AD19-53AFF4B05118",
            "path": "testing-stack/SsmParameterValue:--aws--service--ami-amazon-linux-latest--amzn-ami-hvm-x86_64-gp2:C96584B6-F00A-464E-AD19-53AFF4B05118"
          }
        }
      }
    }
  }
}